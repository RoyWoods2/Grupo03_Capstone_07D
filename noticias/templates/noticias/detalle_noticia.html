{% extends "polls/detail.html" %}
{% load static %}
{% block content %}


<link rel="stylesheet" href="{% static 'noticias/css/styleNoticia.css' %}">


<div class="detalle-noticia-container">
    <h1>{{ noticia.titulo }}</h1>
    <p class="noticia-meta">Redactado por {{ noticia.autor }} el {{ noticia.fecha|date:"d M Y H:" }}</p>
    
    {% if noticia.imagen_encabezado %}
        <img src="{{ noticia.imagen_encabezado.url }}" alt="{{ noticia.titulo }}" class="noticia-imagen">
    {% endif %}
    
    <div class="noticia-contenido">
        {% autoescape off %}

        <p>{{ noticia.contenido }}</p>
        {% endautoescape %}
        </div>
</div>
<div class="comentarios-container">
    <h2>Comentarios</h2>

    <!-- Formulario para agregar un nuevo comentario -->
    {% if user.is_authenticated %}
    <div class="comentario-nuevo">
        <img class="avatar" src="{{ user.userprofile.avatar.url }}" alt="{{ user.username }}">
        <form method="POST">
            {% csrf_token %}
            {{ form.contenido }}
            <button type="submit" class="btn">Comentar</button>
        </form>
    </div>
    {% else %}
    <p><a href="{% url 'polls:login' %}">Inicia sesión</a> para comentar.</p>
    {% endif %}

    <!-- Lista de comentarios -->
    <div class="comentarios-container">
        <h2>Comentarios</h2>
        {% for comentario in comentarios %}
        <div class="comentario">
            <img class="avatar" src="{{ comentario.usuario.userprofile.avatar.url }}" alt="{{ comentario.usuario.username }}">
            <div class="comentario-contenido">
                <div class="comentario-header">
                    <strong>{{ comentario.usuario.userprofile.nick }}</strong>
                    <span>{{ comentario.fecha_publicacion|timesince }}</span>
                </div>
                <p>{{ comentario.contenido }}</p>
    
                <!-- Formulario para responder este comentario -->
                {% if user.is_authenticated %}
                <button id="respuesta-button-{{ comentario.id }}" class="btn btn-link" onclick="toggleRespuestaForm('{{ comentario.id }}')">Responder</button>
                <form id="respuesta-form-{{ comentario.id }}" method="POST" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="comentario_padre_id" value="{{ comentario.id }}">
                    <textarea name="contenido" placeholder="Escribe tu respuesta..." class="form-control mb-2"></textarea>
                    <button type="submit" class="btn btn-primary btn-sm">Enviar Respuesta</button>
                </form>
            {% else %}
                <p><a href="{% url 'polls:login' %}">Inicia sesión</a> para responder.</p>
            {% endif %}
    
                <!-- Mostrar Respuestas -->
                <div class="respuestas">
                    {% for respuesta in comentario.respuestas.all %}
                    <div class="respuesta">
                        <img class="avatar" src="{{ respuesta.usuario.userprofile.avatar.url }}" alt="{{ respuesta.usuario.username }}">
                        <div class="respuesta-contenido">
                            <strong>{{ respuesta.usuario.userprofile.nick }}</strong> - {{ respuesta.fecha_publicacion|timesince }}
                            <p>{{ respuesta.contenido }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>
</div>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<script>
    function toggleRespuestaForm(comentarioId) {
        const form = document.getElementById(`respuesta-form-${comentarioId}`);
        const button = document.getElementById(`respuesta-button-${comentarioId}`);
        form.style.display = 'block'; // Muestra el formulario
        button.style.display = 'none'; // Oculta el botón de Responder
    }
</script>
<script>
    // Reactiva los widgets de Twitter
    window.onload = function () {
        if (typeof twttr !== 'undefined') {
            twttr.widgets.load();
        }
    };
</script>
{% endblock %}